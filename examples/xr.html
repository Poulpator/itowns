<html>
    <head>
        <title>Itowns - Stereo</title>

        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="css/example.css">
        <link rel="stylesheet" type="text/css" href="css/LoadingScreen.css">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">    </head>
    <body>
        <div id="viewerDiv">
          <span id="divScaleWidget"> Scale </span>
        </div>
        </div>
        <script src="../dist/itowns.js"></script>
        <script src="js/GUI/LoadingScreen.js"></script>
        <script type="text/javascript">
            var THREE = itowns.THREE;
        </script>
        <script src="https://cdn.rawgit.com/mrdoob/three.js/dev/examples/js/effects/AnaglyphEffect.js"></script>
        <script src="https://cdn.rawgit.com/mrdoob/three.js/dev/examples/js/effects/ParallaxBarrierEffect.js"></script>
        <script src="https://cdn.rawgit.com/mrdoob/three.js/dev/examples/js/effects/StereoEffect.js"></script>
        <script type="module">
            // Define initial camera position
            import { VRButton } from './libs/webxr/VRButton.js';

            var placement = {
                coord: new itowns.Coordinates('EPSG:4326', 2.351323, 48.856712),
                range: 0,
            }

            // `viewerDiv` will contain iTowns' rendering area (`<canvas>`)
            var viewerDiv = document.getElementById('viewerDiv');

            // Instanciate iTowns GlobeView*
            var view = new itowns.GlobeView(viewerDiv, placement);
            window.view = view;

            // Disable atmosphere lighting
            view.getLayerById('atmosphere').visible = false;
            view.getLayerById('atmosphere').fog.enable = false;

            // Enable XR
            var renderer = view.mainLoop.gfxEngine.renderer;
            renderer.xr.enabled = true;
            document.body.appendChild( VRButton.createButton( renderer ) );

            var cameraGroup = new THREE.Group();
            var camera = view.camera.camera3D;
            cameraGroup.position.copy(camera.position);  // Set the initial VR Headset Position.
            // cameraGroup.updateMatrixWorld();

            //When user turn on the VR mode.
            renderer.xr.addEventListener('sessionstart', function () {
                cameraGroup.add(camera);
                view.scene.add(cameraGroup);
            });
            //When user turn off the VR mode.
            renderer.xr.addEventListener('sessionend', function () {
                view.scene.remove(cameraGroup);
                cameraGroup.remove(camera);
            });

            // renderer.xr.addEventListener('sessionstart', () => {
            //     renderer.xr.getCamera().position.copy(view.camera.position('EPSG:4978').toVector3());
            //     renderer.xr.getCamera().lookAt(view.controls.getLookAtCoordinate().as('EPSG:4978').toVector3());
            //     // renderer.xr.updateCamera(view.camera.camera3D);
            // });

            setupLoadingScreen(viewerDiv, view);

            // Add one imagery layer to the scene
            // This layer is defined in a json file but it could be defined as a plain js
            // object. See Layer* for more info.
            itowns.Fetcher.json('./layers/JSONLayers/Ortho.json').then(function _(config) {
                var source = new itowns.WMTSSource(config.source);
                var layer = new itowns.ColorLayer(config.id, { source });
                view.addLayer(layer);
            });
            // Add two elevation layers.
            // These will deform iTowns globe geometry to represent terrain elevation.
            function addElevationLayerFromConfig(config) {
                config.source = new itowns.WMTSSource(config.source);
                var layer = new itowns.ElevationLayer(config.id, config);
                view.addLayer(layer);
            }
            itowns.Fetcher.json('./layers/JSONLayers/WORLD_DTM.json').then(addElevationLayerFromConfig);
            itowns.Fetcher.json('./layers/JSONLayers/IGN_MNT_HIGHRES.json').then(addElevationLayerFromConfig);
        </script>
    </body>
</html>
